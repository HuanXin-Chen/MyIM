## IM命令行客户端实现

### 设计目标
1. 用来测试 IM 后端系统正确性的一个命令行工具。
2. 使用 go 所编写的 SDK，便于今后集成到压测程序中。
3. 使用命令，可以进行跨网络对话实现 IM 功能。
4. 可使用单元测试运行，以便于自动化测试。

### 技术方案
1. CMD模块：命令解析模块，此模块会解析命令行参数，作为IM的项目微服务化的部署入口，以此做到在一个仓库下开发多个进程程序，复用公共代码，简化部署过程。
2. CUI模块：命令行交互界面模块，使用命令行生成简单的图形界面，用来高效的进行端到端调试。
3. SDK模块：IM客户端逻辑层，用来封装真实的IM客户端行为，抽象出来方便复用，具体可以分为API/logic/net三个子层。

### 技术选型
1. 使用 cobra 组件，作为命令行解析层，众多知名开源golang项目的首选，k8s等等，扩展性好。
2. 使用 gocui 组件，用于绘制UI交互层，简单，代码好读，可以最小化开发成本。


## IM长连接调度引擎实现

### 设计目标
1. 对内连接服务发现&配置中心用于实时获取统计数值计算最佳ip地址以达到长连接网关的负载均衡的目标。
2. 对外提供一个查询endpoint信息的列表接口，规划出最佳连接。
3. 稳定性（P0） + 适配长连接的负载均衡方案 + 保证查询延迟和吞吐

### 技术方案
1. 负载均衡：长连接不像短连接，他的连接是持续的，所以应该衡量不同的指标。基于状态特性，需要有一个动态和静态指标。动态特性基于滑动窗口统计，且通过动态优先的思想做线性规划权衡。
2. 查询延迟和吞吐：计算延迟通过Cache缓存降低复杂度，吞吐能力保证可以通过集群扩展，有条件可以通过 By Pass 从硬件层面提升网络性能。
3. 稳定性建设：稳定建设的核心在于拆解链路，保证 IPConf 服务的旁路特性，且服务发现服务应该保证可用性。
4. 整体思路：服务发现 --> 信息上报 --> 监听信息 --> 获得信息 --> 异步更新候选 --> 分值计算 --> 返回调度方信息

### 技术选型
1. 使用 web 框架 hertz，基于gin封装的简洁高效的web server框架。
2. 使用 ETCD 做服务发现，为追求高可用性，使用ETCD这种CP的分布式kv是合适的。
3. 使用 viper 作为配置解析模块。
4. 使用 etcd 做服务发现，并且上报连接数和每秒收发消息的数据包字节数的剩余值作为统计值。
5. 然后使用 5s 的时间窗口取均值来屏蔽噪声，得到一个稳定的数值进行负载均衡的预估。
6. 由于 etcd 的 watch 机制是与客户端建立长连接进行 push 的，所以 etcd 的压力取决于机器的数量。
7. 所需的数值都是在本地计算的，在线请求无需进行网络调用，因此性能极高，本身可水扩展。
8. 稳定性由 etcd 集群来保证其可靠性。